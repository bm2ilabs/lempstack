#!/bin/bash

######################################################################
#           Auto Install & Optimize LEMP Stack on CentOS 7, 8        #
#                                                                    #
#                Author: Sanvv - HOSTVN Technical                    #
#                  Website: https://hostvn.vn                        #
#                                                                    #
#              Please do not remove copyright. Thank!                #
#  Please do not copy under any circumstance for commercial reason!  #
######################################################################

# shellcheck disable=SC2154
source /var/hostvn/menu/helpers/function

set_var(){
    #https://www.howtoforge.com/tutorial/linux-grep-command/
    #https://stackoverflow.com/a/6284370
    username=$(grep -w "username" "${USER_DIR}/.${domain}.conf" | cut -f2 -d'=');
    php_mode="$(grep "php_mode" "${USER_DIR}/.${domain}.conf" | cut -f2 -d'=')"
}

input(){
    false
    while [ $? -eq 1 ]
    do
        read -r -p "Enter new domain (No www) [0 = Exit]: " newdomain
        if [ "${newdomain}" == "0" ]; then
            break
        else
            newdomain=$(echo "${newdomain}" | tr '[:upper:]' '[:lower:]')
            echo "${newdomain}" | grep -q "\."
            if [ $? -eq 0 ]; then
                "${BASH_DIR}"/menu/validate/check_value domain "${newdomain}"
                if [[ $? -eq 1 ]]; then
                    clear
                    printf "%s\n" "${RED}The name you entered is not correct, please re-enter.${NC}"
                    false
                fi
            else
                clear
                printf "%s\n" "${RED}The name you entered is not correct, please re-enter.${NC}"
                false
            fi
        fi
    done
}

change_path(){
    mv /home/"${username}"/"${domain}" /home/"${username}"/"${newdomain}"
}

change_vhost(){
    mv /etc/nginx/conf.d/"${domain}".conf /etc/nginx/conf.d/"${newdomain}".conf
    sed -i "s/${domain}/${newdomain}/g" /etc/nginx/conf.d/"${newdomain}".conf
}

change_phpconfig(){
    php_conf_path="/etc/php-fpm.d"
    if [[ "${php2_release}" == "yes" && "${php_mode}" == "2" ]]; then
        php_conf_path="/etc/opt/remi/${php2_version}/php-fpm.d"
        if [[ "${php2_version}" == "php56" ]]; then
            php_conf_path="/opt/remi/${php2_version}/root/etc/php-fpm.d"
        fi
    fi

    mv "${php_conf_path}"/"${domain}".conf "${php_conf_path}"/"${newdomain}".conf
    sed -i "s/${domain}/${newdomain}/g" "${php_conf_path}"/"${newdomain}".conf
}

change_user_config(){
    mv "${USER_DIR}"/."${domain}".conf "${USER_DIR}"/."${newdomain}".conf
}

_run(){
    if ! if_is_wordpress "${username}" "${domain}"; then
        change_path
        change_user_config
        change_vhost
        change_phpconfig
        clear
        printf "%s\n" "${GREEN}Change domain success.${NC}"
    else
        clear
        printf "%s\n" "${RED}Website is using WordPress. Please use the domain name change function in the WordPress menu.${NC}"
    fi
}

domain=""
newdomain=""

select_domain

if [ -z "${domain}" ]; then
    clear
    printf "%s\n" "${RED}You have chosen to cancel the action${NC}"
else
    set_var
    input
    if [ "${newdomain}" == "0" ]; then
        clear
        printf "%s\n" "${RED}You have chosen to cancel the action${NC}"
    else
        _run
    fi
fi

menu_domain